<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Voice Bot</title>
</head>
<body>
<h2>Voice Bot</h2>
<button id="startBtn">Start</button>
<button id="stopBtn" disabled>Stop</button>
<script>
let ws;
let mediaStream;
let audioContext;
let processor;

const WS_URL = "wss://YOUR_NGROK_ID.ngrok.io/asr/ws"; // update with ngrok public URL

document.getElementById("startBtn").onclick = async () => {
    audioContext = new (window.AudioContext || window.webkitAudioContext)({sampleRate:16000});
    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    ws = new WebSocket(WS_URL);

    ws.binaryType = "arraybuffer";

    ws.onopen = () => {
        console.log("âœ… Connected to ASR WebSocket");
        document.getElementById("startBtn").disabled = true;
        document.getElementById("stopBtn").disabled = false;

        const source = audioContext.createMediaStreamSource(mediaStream);
        processor = audioContext.createScriptProcessor(1024, 1, 1);

        processor.onaudioprocess = e => {
            const input = e.inputBuffer.getChannelData(0);
            // convert float32 to int16 PCM
            const buffer = new ArrayBuffer(input.length * 2);
            const view = new DataView(buffer);
            for (let i = 0; i < input.length; i++) {
                let s = Math.max(-1, Math.min(1, input[i]));
                view.setInt16(i*2, s < 0 ? s*0x8000 : s*0x7FFF, true);
            }
            ws.send(buffer);
        };

        source.connect(processor);
        processor.connect(audioContext.destination);
    };

    ws.onmessage = async (event) => {
        if (typeof event.data === "string") {
            const json = JSON.parse(event.data);
            console.log("ASR Text:", json.text);
        } else {
            // Audio bytes from server -> play
            const arrayBuffer = await event.data.arrayBuffer();
            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
            const outSource = audioContext.createBufferSource();
            outSource.buffer = audioBuffer;
            outSource.connect(audioContext.destination);
            outSource.start();
        }
    };
};

document.getElementById("stopBtn").onclick = () => {
    processor.disconnect();
    mediaStream.getTracks().forEach(track => track.stop());
    ws.close();
    document.getElementById("startBtn").disabled = false;
    document.getElementById("stopBtn").disabled = true;
};
</script>
</body>
</html>
