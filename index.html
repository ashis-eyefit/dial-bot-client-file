<script>
(async () => {
    const ws = new WebSocket(`ws://${window.location.host}/ws/audio`);
    ws.binaryType = "arraybuffer";

    // Audio playback setup
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const sampleRate = 16000; // match your ASR server
    let audioQueue = [];

    // Decode and play incoming audio bytes from server
    ws.onmessage = async (event) => {
        if (typeof event.data === "string") {
            try {
                const json = JSON.parse(event.data);
                console.log("Server event:", json);
            } catch {
                console.log("Server text:", event.data);
            }
            return;
        }

        const arrayBuffer = await event.data.arrayBuffer();
        // Convert PCM16 to Float32 for Web Audio API
        const pcm16 = new Int16Array(arrayBuffer);
        const float32 = new Float32Array(pcm16.length);
        for (let i = 0; i < pcm16.length; i++) {
            float32[i] = pcm16[i] / 32768;
        }

        const audioBuffer = audioCtx.createBuffer(1, float32.length, sampleRate);
        audioBuffer.copyToChannel(float32, 0);

        const source = audioCtx.createBufferSource();
        source.buffer = audioBuffer;
        source.connect(audioCtx.destination);
        source.start();
    };

    // Capture microphone and send to server
    async function startMic() {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const micCtx = new AudioContext({ sampleRate });
        const source = micCtx.createMediaStreamSource(stream);
        const processor = micCtx.createScriptProcessor(1024, 1, 1);

        source.connect(processor);
        processor.connect(micCtx.destination);

        processor.onaudioprocess = (e) => {
            const input = e.inputBuffer.getChannelData(0);
            const buffer = new ArrayBuffer(input.length * 2);
            const view = new DataView(buffer);
            for (let i = 0; i < input.length; i++) {
                let s = Math.max(-1, Math.min(1, input[i]));
                view.setInt16(i * 2, s < 0 ? s * 32768 : s * 32767, true);
            }
            ws.send(buffer);
        };
    }

    startMic().catch(console.error);
})();
</script>
